const path = require('path')
const readlineSync = require('readline-sync')
const simpleGit = require('simple-git/promise')
const git = simpleGit(path.join(__dirname, '../..'))

const hasNoErrors = async fn => {
  try {
    await git[fn]()
    return true
  } catch (err) {
    return false
  }
}

const commit = async () => {
  await git.add('./*')
  await git.commit('Adding commit - by Elevation PR')
}

const run = async () => {

  const isRepo = await git.checkIsRepo()
  if (!isRepo) {
    await git.init()
    await commit()
  } else {
    const hasCommitHistory = await hasNoErrors('log')
    const status = await git.status()
    if (!hasCommitHistory || status.modified.length || status.created.length) {
      await commit()
    }
  }

  const hasRemote = await hasNoErrors('listRemote')
  if (!hasRemote) {
    const remote = readlineSync.question('IN ORDER TO CONTINUE: Couldn\'t find a remote repository, please paste the link to your remote repo here and press "Enter": \n')
    git.addRemote('origin', remote)
  }

  const { current } = await git.branch()

  await git.checkout(['--orphan', 'review'])
  await git.raw(['rm', '-rf', '.'])
  await git.commit('first commit', { "--allow-empty": true })
  await git.raw(['rebase', '--onto', 'review', '--root', current])
  await git.push('origin', current, { "--force": true })
  await git.checkout(['review'])
  await git.push('origin', 'review', { "--force": true })
  await git.checkout([current])

  console.log('All good, you can now create your pull request on Github :)')
}

run()